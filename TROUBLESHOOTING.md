# 🔧 トラブルシューティングガイド

このガイドでは、Fractal Analyzer V2で発生する可能性のある問題と、その解決方法を詳しく説明します。

---

## 目次

1. [インストール・起動の問題](#インストール起動の問題)
2. [学習モードの問題](#学習モードの問題)
3. [推論モードの問題](#推論モードの問題)
4. [精度検証モードの問題](#精度検証モードの問題)
5. [精度・性能の問題](#精度性能の問題)
6. [エラーメッセージ一覧](#エラーメッセージ一覧)

---

## インストール・起動の問題

### ❌ 問題: `ModuleNotFoundError: No module named 'streamlit'`

**原因**: 依存パッケージがインストールされていない

**解決方法**:
```powershell
# 仮想環境を有効化
.\.venv\Scripts\Activate.ps1

# 依存パッケージをインストール
pip install -r requirements.txt
```

**確認方法**:
```powershell
pip list | findstr streamlit
# streamlit 1.x.x が表示されればOK
```

---

### ❌ 問題: 仮想環境が有効化できない

**症状**:
```
このシステムではスクリプトの実行が無効になっているため...
```

**原因**: PowerShellの実行ポリシー制限

**解決方法1** (推奨):
```powershell
# 管理者権限でPowerShellを開く
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

**解決方法2** (一時的):
```powershell
PowerShell -ExecutionPolicy Bypass -File .\.venv\Scripts\Activate.ps1
```

**解決方法3** (コマンドプロンプトを使用):
```cmd
.venv\Scripts\activate.bat
streamlit run fractal_app.py
```

---

### ❌ 問題: ブラウザが自動で開かない

**解決方法**:
1. ターミナルに表示されるURLを確認:
   ```
   Local URL: http://localhost:8501
   Network URL: http://192.168.x.x:8501
   ```

2. ブラウザを手動で開いて、URLを入力:
   ```
   http://localhost:8501
   ```

3. ポートが使用中の場合:
   ```powershell
   streamlit run fractal_app.py --server.port 8502
   ```

---

### ❌ 問題: Pythonのバージョンが古い

**症状**:
```
Python 3.7.x では動作しません
```

**確認方法**:
```powershell
python --version
# Python 3.8以上が必要
```

**解決方法**:
1. Python 3.8以上をインストール: https://www.python.org/downloads/
2. 仮想環境を再作成:
   ```powershell
   python -m venv .venv
   .\.venv\Scripts\Activate.ps1
   pip install -r requirements.txt
   ```

---

## 学習モードの問題

### ❌ 問題: 画像ペアが検出されない (0組)

**症状**:
```
✅ 0組の画像ペアを検出しました
```

**原因1**: ファイル命名規則が違う

**確認**:
```
正しい例:
  高画質: IMG_5023.jpg
  低画質: IMG_5023_low1.jpg
  
間違った例:
  高画質: IMG_5023.jpg
  低画質: IMG_5023-low1.jpg  ← アンダースコアではなくハイフン
  低画質: IMG_5023_Low1.jpg  ← 大文字小文字
```

**解決方法**:
- ファイル名を修正して、`_low1`, `_low2` 等の形式に統一

---

**原因2**: フォルダパスが間違っている

**確認**:
```powershell
# フォルダが存在するか確認
Test-Path "E:\画質別頬画像(元画像＋10段階)"
# True が返ればOK
```

**解決方法**:
- エクスプローラーでフォルダを開き、アドレスバーからパスをコピー
- アプリのフォルダパス入力欄に貼り付け

---

**原因3**: ファイル拡張子が違う

**確認**:
```
フォルダ内のファイル:
  IMG_5023.JPG  ← 大文字
  IMG_5023_low1.jpg  ← 小文字
```

**解決方法**:
- ファイルパターンを「*.JPG」または「*.*」に変更
- またはファイル拡張子を統一

---

### ❌ 問題: 学習が途中で止まる・エラーになる

**症状**:
```
処理中に停止...
```

**原因1**: メモリ不足

**確認方法**:
- タスクマネージャーでメモリ使用率を確認

**解決方法**:
```
1. データ拡張の種類を減らす (28種類 → 15種類)
2. 一度に処理する画像数を減らす
3. 他のアプリケーションを閉じる
4. PCを再起動してメモリを解放
```

---

**原因2**: 画像ファイルが破損している

**確認方法**:
- 画像が正常に開けるか確認

**解決方法**:
- 破損した画像を除外
- または画像を再保存

---

**原因3**: GPUメモリ不足

**症状**:
```
CUDA out of memory
```

**解決方法**:
- コード内の`use_gpu=False`に変更
- または小さいバッチサイズで処理

---

### ❌ 問題: 学習に時間がかかりすぎる

**症状**:
- 30分以上経っても終わらない

**原因**: データ数が多すぎる、またはCPU処理が遅い

**確認**:
```
データ数の計算:
元画像30組 × 品質レベル4 × データ拡張28種類 = 3,360組
→ 処理時間: 約15-20分
```

**対策**:
1. **データ拡張を減らす**:
   - 28種類 → 15種類に変更
   - 処理時間: 約半分に短縮

2. **品質レベルを減らす**:
   - low4-7グループ → low1単体
   - データ数: 3,360組 → 840組

3. **GPU使用** (対応している場合):
   - 処理時間が大幅に短縮

---

## 推論モードの問題

### ❌ 問題: モデルが読み込めない

**症状**:
```
⚠️ モデルファイルが見つかりません
```

**原因**: `trained_fd_model.pkl`が存在しない

**解決方法**:
1. 先に学習モードでモデルを作成
2. またはサンプルモデルをダウンロード

**確認方法**:
```powershell
# ファイルが存在するか確認
Test-Path ".\trained_fd_model.pkl"
# True が返ればOK
```

---

### ❌ 問題: 予測結果がおかしい

**症状**:
```
予測FD: 0.5  ← 異常に低い
または
予測FD: 5.0  ← 異常に高い
```

**原因**: モデルと画像の品質レベルが不一致

**確認**:
```
モデル: low1で学習
入力画像: IMG_5023_low8.jpg  ← ミスマッチ!
```

**解決方法**:
- モデルと同じ品質レベルの画像を使用
- または該当品質レベルで再学習

---

### ❌ 問題: 信頼度が常に低い

**症状**:
```
総合信頼度: 20% 🔴
```

**原因1**: 入力画像の品質が極端に悪い

**確認**:
- 画像を目視確認
- ノイズが多すぎる、ぼやけすぎている

**解決方法**:
- 品質の良い画像を使用
- または該当品質レベルで再学習

---

**原因2**: モデルの精度が低い

**確認**:
- 学習時の相関係数を確認 (85%以下なら低い)

**解決方法**:
- 高精度モデル(low1)で再学習
- データ拡張を増やす

---

## 精度検証モードの問題

### ❌ 問題: ペアが自動検出されない

**症状**:
```
⚠️ 0組のペアが見つかりました
```

**原因**: ファイル名の命名規則が違う

**確認**:
```
正しい例:
  高画質: IMG_5023.jpg
  低画質: IMG_5023_low1.jpg
  → ペア検出: ✅

間違った例:
  高画質: IMG_5023.jpg
  低画質: IMG_5024_low1.jpg  ← 番号が違う
  → ペア検出: ❌
```

**解決方法**:
- ファイル名を確認し、正しくペアになるように修正

---

### ❌ 問題: 相関係数がNaNになる

**症状**:
```
相関係数: nan
```

**原因1**: サンプル数が1つだけ

**解決方法**:
- 最低3組以上のペアをアップロード

---

**原因2**: すべての値が同じ

**症状**:
```
実測FD: 2.6801, 2.6801, 2.6801  ← 全部同じ
```

**原因**:
- 同じ画像を複数回アップロードしている

**解決方法**:
- 異なる画像をアップロード

---

### ❌ 問題: 誤差が異常に大きい (30%以上)

**症状**:
```
実測FD: 2.04
予測FD: 2.83
相対誤差: 38%
```

**原因**: 学習時と検証時でFD計算方法が違っていた

**解決方法**:
1. **最新版のコードを使用**:
   ```powershell
   git pull origin main
   ```

2. アプリを再起動

3. 精度検証を再実行

**期待される結果**:
```
実測FD: 2.68
予測FD: 2.83
相対誤差: 5.77%  ← 正常範囲
```

---

## 精度・性能の問題

### ❌ 問題: 相関係数が85%以下

**症状**:
```
💫 精度改善が必要です
相関係数: 0.82
```

**診断チェックリスト**:

#### ☑️ チェック1: データ数は十分か

**確認**:
```
学習結果画面で確認:
  総サンプル数: 150組  ← 少なすぎ！
```

**基準**:
| データ数 | 評価 | 期待精度 |
|---------|------|----------|
| 100組未満 | ❌ 不足 | 70-80% |
| 100-500組 | ⚠️ 最低限 | 80-90% |
| 500-1000組 | ✅ 十分 | 90-95% |
| 1000組以上 | 🌟 理想 | 95%+ |

**解決方法**:
```
元画像30組の場合:
❌ データ拡張5種類 → 180組
✅ データ拡張28種類 → 870組 (推奨)
```

---

#### ☑️ チェック2: データ拡張は十分か

**確認**:
```
学習設定画面で確認:
  選択したデータ拡張: 5種類  ← 少ない！
```

**基準**:
| 拡張種類数 | 評価 | 影響 |
|-----------|------|------|
| 0-5種類 | ❌ 不足 | 過学習リスク大 |
| 6-14種類 | ⚠️ 最低限 | 汎用性やや低 |
| 15-20種類 | ✅ 良好 | 推奨レベル |
| 21-28種類 | 🌟 最高 | 最高の汎用性 |

**解決方法**:
- データ拡張で「すべて選択」ボタンをクリック (28種類)

---

#### ☑️ チェック3: 品質レベルは適切か

**確認**:
```
学習設定画面で確認:
  品質レベル: 全レベル(low1-10)  ← 非推奨！
```

**各品質レベルの特性**:
| 品質レベル | 相関係数 | MAE | 推奨度 |
|-----------|----------|-----|--------|
| **low1** | 97.25% | 0.024 | 🌟🌟🌟🌟🌟 最高精度 |
| low4 | 97.05% | 0.024 | 🌟🌟🌟🌟 高精度 |
| low4-7グループ | 94.14% | 0.037 | 🌟🌟🌟 汎用性 |
| low8 | 92.90% | 0.041 | 🌟🌟 低品質用 |
| 全レベル | 85-90% | 0.04+ | ❌ 非推奨 |

**解決方法**:
- **high精度が必要**: low1を選択
- **汎用性重視**: low4-7グループを選択
- **避ける**: 全レベル(low1-10)

---

#### ☑️ チェック4: 画像の品質は適切か

**確認**:
- 画像を目視確認
- ぼやけすぎ、ノイズが多すぎないか

**基準**:
```
✅ 良い例:
  - 被写体が明確に見える
  - ノイズが少ない
  - 適度なコントラスト

❌ 悪い例:
  - 被写体が判別できない
  - ノイズだらけ
  - 真っ黒または真っ白
```

**解決方法**:
- 品質の悪い画像を除外
- または画像を再撮影

---

### 📊 精度改善の実践例

**ケース1: 相関係数75% → 97%に改善**

**Before**:
```
元画像: 30組
データ拡張: 5種類
品質レベル: 全レベル(low1-10)
総データ数: 30 × 10 × 6 = 1,800組
結果: 相関係数 75%, MAE 0.08
```

**After**:
```
元画像: 30組
データ拡張: 28種類
品質レベル: low1
総データ数: 30 × 1 × 29 = 870組
結果: 相関係数 97.25%, MAE 0.024 ✅
```

**改善ポイント**:
1. 品質レベルを統一 (全レベル → low1)
2. データ拡張を大幅に増加 (5種類 → 28種類)

---

## エラーメッセージ一覧

### Python関連エラー

#### `ImportError: DLL load failed`
**原因**: Visual C++ ランタイムが不足
**解決方法**: Visual C++ Redistributable をインストール

#### `OSError: [WinError 126]`
**原因**: DLLファイルが見つからない
**解決方法**: 依存パッケージを再インストール

#### `UnicodeDecodeError`
**原因**: ファイルパスに対応していない文字
**解決方法**: ファイルパスを英数字のみに変更

---

### Streamlit関連エラー

#### `StreamlitAPIException`
**原因**: Streamlitの使い方が間違っている
**解決方法**: アプリを再起動

#### `DuplicateWidgetID`
**原因**: 同じIDのウィジェットが複数存在
**解決方法**: ページをリロード (F5)

---

### 画像処理関連エラー

#### `cv2.error: OpenCV(4.x.x) error`
**原因**: 画像ファイルが読み込めない
**解決方法**: 画像ファイルの形式・破損を確認

#### `ValueError: could not convert string to float`
**原因**: 数値変換エラー
**解決方法**: 入力データを確認

---

## サポートが必要な場合

### 問題報告の方法

1. **GitHubのIssuesに報告**:
   - https://github.com/ryuki4219/Fractal-Analyzer-V2/issues

2. **含めるべき情報**:
   ```
   - OS: Windows 10/11
   - Pythonバージョン: python --version
   - エラーメッセージ全文
   - 再現手順
   - スクリーンショット
   ```

3. **ログの取得方法**:
   ```powershell
   streamlit run fractal_app.py > log.txt 2>&1
   ```

---

## よくある質問 (FAQ)

### Q1: 学習にどれくらい時間がかかりますか?
**A**: データ数により異なります
- 870組: 約5-10分
- 3,480組: 約15-20分
- GPU使用時: 約半分の時間

### Q2: 最低限必要な画像数は?
**A**: 
- 元画像: 最低10組、推奨30組以上
- データ拡張後: 最低100組、推奨500組以上

### Q3: どの品質レベルが一番精度が高いですか?
**A**: low1が最高精度 (相関係数97.25%)

### Q4: 複数の品質レベルで同時に学習できますか?
**A**: はい、グループ選択機能を使用してください

### Q5: 学習したモデルは保存されますか?
**A**: はい、自動的に`trained_fd_model.pkl`として保存されます

### Q6: 既存モデルをバックアップするには?
**A**: `trained_fd_model.pkl`を別名でコピーしてください

### Q7: GPUは必須ですか?
**A**: いいえ、CPUでも動作します（処理時間は長くなります）

### Q8: 商用利用は可能ですか?
**A**: ライセンスファイルを確認してください

---

## 更新履歴

- 2025-11-11: 初版作成
  - 主要な問題と解決方法を網羅
  - 精度改善の詳細ガイド追加
  - FAQ追加
