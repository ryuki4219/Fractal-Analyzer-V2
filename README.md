# Fractal Analyzer V2

フラクタル次元解析とAIを活用した画像補完異常検知システム

## 起動方法

### 🚀 **最も確実な方法（推奨）**

1. **エクスプローラーでフォルダを開く**
2. **`簡単起動.bat`** をダブルクリック
3. ブラウザで **http://localhost:8501** を開く

### 方法1: デスクトップから起動
1. **初回のみ**: `デスクトップショートカット作成.bat` を実行
2. デスクトップの `Fractal Analyzer V2` をダブルクリック
3. ブラウザで **http://localhost:8501** を開く

### 方法2: 直接起動
1. `起動.bat` をダブルクリック
2. ブラウザで **http://localhost:8501** を開く

### 方法3: コマンドラインから起動
```cmd
.venv\Scripts\activate.bat
streamlit run fractal_app.py --server.port 8501
```

### ⚠️ トラブルシューティング

#### アプリが開けない場合

1. **`トラブルシューティング.bat`** を実行して診断
2. 表示されるエラーメッセージを確認
3. 以下の解決策を試す：

#### ケース1: ブラウザが自動で開かない
- 手動で **http://localhost:8501** を開く
- Chrome、Edge、Firefoxなどを使用

#### ケース2: ポートが使用中
```cmd
REM 既存のプロセスを終了
taskkill /F /IM streamlit.exe
REM 再起動
起動.bat
```

#### ケース3: ライブラリエラー
```cmd
.venv\Scripts\activate.bat
pip install -r requirements.txt
```

#### ケース4: 仮想環境が見つからない
```cmd
python -m venv .venv
.venv\Scripts\activate.bat
pip install -r requirements.txt
```

ブラウザで自動的に開きます: http://localhost:8501

## 主な機能

- **フラクタル次元解析**: ボックスカウント法による解析（高速化対応）
- **AI画像補完**: データ拡張による不足データの補完（精度・速度調整可能）
- **🔄 学習継続性**: モデルと学習履歴を自動保存・次回起動時に自動復元
- **異なるサイズの画像に対応**: 低画質と高画質のサイズが違っても自動統一
- **AI補正精度評価**: 自動評価システムでS~Dランク判定
- **フラクタル次元比較**: 低画質・AI補正後・高画質の3つを線グラフで比較
- **学習データ数表示**: データ拡張後の学習件数をリアルタイム表示
- **閾値調整**: UI上でリアルタイム調整
- **比較分析**: 複数画像の比較とヒートマップ表示
- **異常検知**: 統計的手法による検出
- **結果保存**: CSV/JSON形式でエクスポート（評価データ含む）

## 🔄 学習継続性機能

**アプリを閉じても、AIの知識と学習履歴が保持されます！**

### 自動保存される情報

1. **🤖 学習済みAIモデル**
   - ファイル: `trained_fd_model.pkl`
   - 内容: AIの学習結果（重み、パラメータ）
   - 自動読み込み: 次回起動時に自動的に復元

2. **📚 学習履歴**
   - ファイル: `training_history.json`
   - 内容: 
     - 学習回数
     - 学習日時
     - 使用データ数
     - 性能指標（相関係数、MAE、改善率）
   - 蓄積: 学習するたびに追加

3. **📊 AI成長レポート**
   - サイドバーに信頼度表示
   - レベル: 🌱入門 → 🏆マスター (90%以上)
   - 成長グラフで進捗を可視化

### 使い方

#### 初回学習
1. 学習モードで画像を学習
2. モデルと履歴が自動保存される
3. ✅ 緑色の通知で保存完了を確認

#### 2回目以降の起動
1. アプリを起動
2. 自動的に前回のモデルを読み込み
3. ✅ 前回の学習状態から継続
4. 📊 累計の学習回数・データ数が表示

#### 追加学習
1. 新しいデータで再学習
2. 既存の履歴に追加保存
3. 📈 信頼度が向上

#### リセット
- サイドバーの「🔄 モデルをリセット」ボタン
- または、ファイルを手動削除:
  - `trained_fd_model.pkl`
  - `training_history.json`

### 利点

- ✅ **すぐに使える**: 学習済みモデルで即座に推論開始
- ✅ **成長記録**: 学習の進捗を可視化
- ✅ **データ保護**: アプリを閉じても学習成果が消えない
- ✅ **継続改善**: 新しいデータで段階的に性能向上

## 📐 画像サイズ自動統一機能

**異なるサイズの画像でも学習・補完が可能!**

例:
- 低画質画像: 800×600
- 高画質画像: 1920×1080
→ 自動的にサイズを統一して学習

### 4つの統一モード

| モード | 説明 | 用途 |
|--------|------|------|
| 🔼 **大きい方に合わせる（推奨）** | 高解像度を保持 | 画質を優先したい場合 |
| 🔽 小さい方に合わせる | 処理速度を優先 | 高速処理が必要な場合 |
| 📷 高画質に合わせる | 高画質画像を基準 | 高画質が正解データの場合 |
| 📱 低画質に合わせる | 低画質画像を基準 | 低画質の特徴を保持したい場合 |

## 🎯 AI補正精度評価システム

### 自動評価ランク

アプリが自動的にAI補正の精度を評価します:

| ランク | 改善率 | 評価 | 説明 |
|--------|--------|------|------|
| 🟢 **S** | 90%以上 | 優秀 | 高画質にほぼ完全に近づいています |
| 🔵 **A** | 75-90% | 良好 | 高い補正精度を達成しています |
| 🟡 **B** | 60-75% | 普通 | 一定の補正効果が見られます |
| 🟠 **C** | 40-60% | 要改善 | 補正効果が限定的です |
| 🔴 **D** | 40%未満 | 不良 | 補正が不十分です |

### 表示される指標

1. **📚 学習データ数**: データ拡張後の学習件数（例: 3枚 → バランスモードで6枚）
2. **📈 フラクタル次元比較**: 低画質 → AI補正後 → 高画質の推移を線グラフで表示
3. **改善率**: 低画質から高画質への距離のうち、どれだけ近づいたか
4. **目標との差**: AI補正後と高画質のフラクタル次元の差
5. **改善度**: 低画質からAI補正後への変化量

## ⚖️ 精度・速度バランス設定

アプリのサイドバーで3つのモードから選択可能:

| モード | 処理時間 | 精度 | 推奨用途 |
|--------|----------|------|----------|
| **⚡ 高速** | ~15秒 | 中 | テスト・プレビュー用 |
| **⚖️ バランス（推奨）** | ~30秒 | 高 | 通常の解析作業 |
| **🎯 高精度** | ~90秒 | 最高 | 論文・発表用の高品質出力 |

### 技術詳細

各モードのパラメータ:

| パラメータ | 高速 | バランス | 高精度 |
|-----------|------|----------|--------|
| 画像サイズ | 256px | 384px | 512px |
| 決定木の数 | 10 | 20 | 50 |
| 木の深さ | 5 | 10 | 15 |

## パフォーマンス最適化

- **適応型画像リサイズ**: 大画像を自動的に最適サイズに縮小
- **高品質補間**: LANCZOS4アルゴリズムで画質劣化を最小化
- **過学習防止**: min_samples_split/leafで汎化性能向上
- **データ拡張の最適化**: 回転180°+水平反転で3倍に増強
- **フラクタル解析の改善**: ボックスサイズを6段階に最適化
- **3D描画の高速化**: 解像度を最大128pxに制限
- **並列処理**: n_jobs=-1で全CPUコアを活用

## トラブルシューティング

### 起動しない場合
1. 起動.bat を再実行
2. それでもダメなら手動実行:
   `
   .venv\Scripts\activate
   streamlit run fractal_app.py
   `

### ブラウザが開かない
http://localhost:8501 を手動で開く

## システム要件

- Python 3.8以上
- Windows 10/11
- 依存ライブラリ: requirements.txt

## ライセンス

MIT License
