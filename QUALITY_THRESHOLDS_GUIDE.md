# 画質判定の閾値設定と処理範囲

**作成日**: 2025年11月17日

---

## 📊 3つの処理範囲と閾値

### 1️⃣ **直接解析範囲 (high品質)**
Box-counting法で直接フラクタル次元を計算する高品質画像

#### 判定基準（すべて満たす必要あり）:

| メトリクス | 閾値 | 説明 |
|-----------|------|------|
| **解像度スコア** | ≥ 90% | 基準(1920×1080)の90%以上 |
| **シャープネス** | ≥ 200 | ラプラシアン分散 |
| **ノイズレベル** | ≤ 30 | Sobelフィルタによる測定 |
| **JPEG品質** | ≥ 75 | ファイルサイズベース推定 |

#### 実際の画像例:
```
解像度: 1920×1080 以上 (約207万画素以上)
例: 3000×4000 (1200万画素) - スマホ撮影
    2560×1920 (491万画素) - デジカメ
    
ファイルサイズ: 2MB以上
シャープネス: 200以上（鮮明な画像）
ノイズ: 30以下（クリーンな画像）
```

#### 処理方法:
- ✅ **Box-counting法で直接解析**
- ✅ 最も高精度なフラクタル次元測定
- ✅ 信頼性100%

---

### 2️⃣ **AI予測範囲 (low4-7品質 - Golden Zone)**
AIモデルで予測する中品質画像（精度保証あり）

#### 判定基準（すべて満たす必要あり）:

| メトリクス | 閾値 | 説明 |
|-----------|------|------|
| **解像度スコア** | ≥ 45% | 基準の45%以上 |
| **シャープネス** | ≥ 40 | 最低限の鮮明度 |
| **ノイズレベル** | ≤ 50 | 許容範囲内のノイズ |
| **JPEG品質** | 40～74 | 中程度の圧縮 |

#### 実際の画像例:
```
解像度: 720×1280以上、または960×960以上 (約93万画素以上)
例: 960×1280 (123万画素)
    720×1440 (104万画素)
    800×1166 (93万画素)
    
ファイルサイズ: 400KB～2MB
シャープネス: 40～200（やや鮮明～鮮明）
ノイズ: 30～50（若干のノイズあり）
```

#### 処理方法:
- 🤖 **AI予測モデル使用**
- ✅ MAE < 0.02の高精度保証
- ✅ 相関係数 > 0.94
- ✅ 信頼性が高い（Golden Zone）

#### なぜAI予測が有効か:
- 直接解析では精度が落ちる品質レベル
- AIモデルが高品質画像で学習済み
- 実験により精度が証明されている

---

### 3️⃣ **切り捨て範囲 (low8-10品質)**
解析不可能な低品質画像（完全拒否）

#### 判定基準（以下のいずれかに該当）:

| メトリクス | 閾値 | 説明 |
|-----------|------|------|
| **解像度スコア** | < 45% | 基準の45%未満 |
| **シャープネス** | < 40 | 極端にぼやけている |
| **ノイズレベル** | > 50 | ノイズが多すぎる |
| **JPEG品質** | < 40 | 過度に圧縮されている |

#### 実際の画像例:
```
解像度: 720×1280未満、または93万画素未満
例: 208×208 (4.3万画素) - 切り出し画像
    640×480 (30.7万画素) - 低解像度
    600×1280 (76.8万画素) - 縦長だが画素数不足
    
ファイルサイズ: 400KB未満
シャープネス: 40未満（ぼやけている）
ノイズ: 50超（ノイズが多い）
```

#### 処理方法:
- ❌ **完全拒否 - 処理しない**
- ❌ 直接解析もAI予測も不可能
- ❌ 信頼できる結果が得られない

#### 拒否する理由:
1. **解析精度の保証不可能**
   - Box-counting法: スケール不足で計算不可
   - AI予測: 学習データ範囲外で精度低下

2. **科学的信頼性の欠如**
   - 結果の再現性がない
   - 誤差が大きすぎる

3. **ユーザー保護**
   - 誤った結果による誤解を防ぐ
   - 適切な画像使用を促す

---

## 📋 品質レベル別の処理フロー

```
┌─────────────────────────────────────────────────────────────┐
│                    画像アップロード                          │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│                    品質自動判定                              │
│  - 解像度スコア計算                                          │
│  - シャープネス測定                                          │
│  - ノイズレベル測定                                          │
│  - JPEG品質推定                                              │
└─────────────────────────────────────────────────────────────┘
                           ↓
              ┌────────────┴────────────┐
              ↓                         ↓
    ┌──────────────────┐      ┌──────────────────┐
    │  high品質判定     │      │  low4-7判定      │
    │                   │      │  (Golden Zone)   │
    │  すべての閾値を   │      │  中程度の閾値を  │
    │  満たす           │      │  満たす          │
    └──────────────────┘      └──────────────────┘
              ↓                         ↓
    ┌──────────────────┐      ┌──────────────────┐
    │ Box-counting法   │      │  AI予測モデル    │
    │ 直接解析         │      │  使用            │
    │                   │      │                   │
    │ 精度: 最高        │      │ 精度: MAE<0.02   │
    │ 信頼性: 100%      │      │ 信頼性: 高       │
    └──────────────────┘      └──────────────────┘
              ↓                         ↓
    ┌──────────────────────────────────────────┐
    │        フラクタル次元 + 肌品質評価        │
    │        (S/A/B/C/D グレード)              │
    └──────────────────────────────────────────┘

                        OR
                        
              ┌────────────┐
              │ low8-10判定│
              │  (低品質)  │
              │            │
              │ 閾値未達   │
              └────────────┘
                    ↓
              ┌────────────┐
              │  完全拒否  │
              │            │
              │ エラー表示 │
              │ 再撮影推奨 │
              └────────────┘
```

---

## 🔬 実測データ例

### ✅ High品質 (直接解析)
```
解像度: 2316×3088 (715万画素)
解像度スコア: 344.9%
シャープネス: 591.18
ノイズレベル: 28.45
JPEG品質: 85
判定: high → Box-counting法で直接解析
```

### ⚠️ Low4-7品質 (AI予測)
```
解像度: 1280×960 (123万画素)
解像度スコア: 59.3%
シャープネス: 64.59
ノイズレベル: 22.18
JPEG品質: 65
判定: low4-7 → AI予測モデル使用
```

### ❌ Low8-10品質 (拒否)
```
解像度: 208×208 (4.3万画素)
解像度スコア: 2.09%
シャープネス: 111.53
ノイズレベル: 24.40
JPEG品質: 50
判定: low8-10 → 完全拒否
```

---

## 💡 推奨される画像準備

### 📱 直接解析を目指す場合 (最高精度)

**撮影デバイス**:
- iPhone 8以降
- Galaxy S10以降
- デジタル一眼レフ
- ミラーレスカメラ

**設定**:
- 解像度: 最高設定
- JPEG品質: 90%以上
- フラッシュ: OFF（自然光推奨）
- 手ブレ補正: ON

**結果**:
- 解像度: 3000×4000程度
- ファイルサイズ: 3～10MB
- → **high品質判定 → 直接解析**

### 🤖 AI予測でも可 (高精度保証)

**撮影デバイス**:
- iPhone 6/7
- Galaxy S7～S9
- 中級デジカメ

**設定**:
- 解像度: 中～高設定
- JPEG品質: 70%程度
- 照明: 明るい環境

**結果**:
- 解像度: 1280×960～2000×1500
- ファイルサイズ: 500KB～2MB
- → **low4-7判定 → AI予測（MAE<0.02保証）**

---

## 📊 まとめ表

| 品質レベル | 解像度スコア | シャープネス | ノイズ | JPEG品質 | 処理方法 | 精度 |
|-----------|------------|-------------|--------|----------|---------|------|
| **high** | ≥90% | ≥200 | ≤30 | ≥75 | 直接解析 | 最高 |
| **low4-7** | ≥45% | ≥40 | ≤50 | 40-74 | AI予測 | MAE<0.02 |
| **low8-10** | <45% | <40 | >50 | <40 | 拒否 | - |

### 実際の解像度目安:

| 品質レベル | 最小解像度 | 推奨解像度 | 画素数 |
|-----------|-----------|-----------|--------|
| **high** | 1920×1080 | 3000×4000 | 207万～1200万画素 |
| **low4-7** | 720×1280 | 960×1280 | 93万～150万画素 |
| **low8-10** | - | - | 93万画素未満（拒否） |

---

## 🎯 実用ガイド

### あなたの画像はどのレベル？

#### 確認方法:

1. **ファイルサイズを確認**
   ```powershell
   Get-Item "画像.jpg" | Select-Object Length
   ```
   - 2MB以上 → おそらくhigh
   - 500KB～2MB → おそらくlow4-7
   - 500KB未満 → low8-10の可能性

2. **解像度を確認**
   - Windowsエクスプローラーで右クリック → プロパティ → 詳細
   - 1920×1080以上 → high狙い
   - 1000×1000以上 → low4-7狙い
   - 1000×1000未満 → 再撮影推奨

3. **アプリで判定**
   - アップロード → 自動判定
   - 品質レベルが表示されます

---

**画質判定システムは3段階の処理を自動で判断し、最適な方法でフラクタル次元を計算します！** ✨
