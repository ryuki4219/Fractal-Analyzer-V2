# 📘 Fractal Analyzer V2 - 完全使用ガイド

## 目次
1. [はじめに](#はじめに)
2. [インストール](#インストール)
3. [起動方法](#起動方法)
4. [学習モード - AIモデルの作成](#学習モード)
5. [推論モード - FD値の予測](#推論モード)
6. [精度検証モード - モデルの評価](#精度検証モード)
7. [ベストプラクティス](#ベストプラクティス)
8. [トラブルシューティング](#トラブルシューティング)

---

## はじめに

このアプリは、低画質の画像から高画質相当のフラクタル次元(FD)を予測するAIシステムです。

### 主な機能
- 🎓 **学習モード**: 画像ペアからAIモデルを作成
- 🔮 **推論モード**: 低画質画像からFD値を予測
- 🎯 **精度検証モード**: モデルの精度を評価

---

## インストール

### 必要な環境
- Python 3.8以上
- Windows 10/11 (推奨)
- メモリ: 8GB以上推奨

### インストール手順

1. **リポジトリをクローン**
```bash
git clone https://github.com/ryuki4219/Fractal-Analyzer-V2.git
cd Fractal-Analyzer-V2
```

2. **仮想環境を作成**
```bash
python -m venv .venv
```

3. **仮想環境を有効化**
```powershell
# Windows PowerShell
.\.venv\Scripts\Activate.ps1

# コマンドプロンプト
.\.venv\Scripts\activate.bat
```

4. **依存パッケージをインストール**
```bash
pip install -r requirements.txt
```

---

## 起動方法

### 方法1: バッチファイルから起動（推奨）
```
起動.bat をダブルクリック
```

### 方法2: コマンドラインから起動
```bash
# 仮想環境を有効化してから
streamlit run fractal_app.py
```

起動すると、ブラウザが自動的に開きます（通常は `http://localhost:8501`）

---

## 学習モード

### 🎯 目標
高精度のAIモデルを作成する（相関係数97%以上を目指す）

### 📋 準備するもの
- 高画質画像と低画質画像のペア
- 推奨: 30組以上の画像ペア
- ファイル命名規則: `IMG_XXXX.jpg` (高画質) と `IMG_XXXX_low1.jpg` (低画質)

### 🚀 ステップバイステップガイド

#### Step 1: 学習モードを選択
1. アプリのトップページで「🎓 学習モード」を選択
2. 画面上部のタブが「🎓 学習モード - AIを学習させる」になることを確認

#### Step 2: 画像の読み込み
1. **画像読み込みモード**を選択:
   - 📁 **フォルダから自動ペアリング**（推奨）: 同じフォルダ内の画像を自動でペアリング
   - 📤 手動アップロード: 個別に画像をアップロード

2. **フォルダモードの場合**:
   ```
   フォルダパス例: E:\画質別頬画像(元画像＋10段階)
   ```
   - フォルダパスを入力
   - ファイル名パターンを選択（通常は `IMG_*.jpg`）

#### Step 3: 品質レベルを選択

**🌟 推奨設定（高精度モデル）**:
```
品質レベルグループ: 📗 個別選択
低画質レベル: low1
```

**理由**: low1は相関係数97.25%が期待できる最高精度モデル

**その他の選択肢**:
| 品質レベル | 相関係数 | MAE | 用途 |
|-----------|----------|-----|------|
| **low1** | 97.25% | 0.024 | 高精度が必要な場合 ⭐推奨 |
| low4 | 97.05% | 0.024 | バランス型 |
| low4-7グループ | 94.14% | 0.037 | 汎用性重視 |
| low8 | 92.90% | 0.041 | 低品質画像用 |

#### Step 4: データ拡張を設定

1. 「データ拡張」タブを開く
2. **「すべて選択」ボタンをクリック**（28種類すべて選択）

**推奨**: 必ず15種類以上選択してください
- データ数が増えて精度が向上
- 過学習を防止
- 汎用性が向上

#### Step 5: 学習を実行

1. **「🚀 学習開始」ボタンをクリック**
2. 進行状況を確認:
   - データ拡張の進行状況
   - 学習の進行状況（プログレスバー）
3. 完了まで待機（5-15分程度）

#### Step 6: 結果を確認

学習完了後、以下の情報が表示されます:
- ✅ **相関係数** (correlation): 97%以上が目標
- ✅ **MAE** (平均絶対誤差): 0.03以下が目標
- ✅ **R²スコア**: 0.93以上が目標
- ✅ **改善率**: 高いほど良い

**良い結果の例**:
```
相関係数 (高画質ペア間): 0.8710
相関係数 (低→高予測): 0.9780 ✅ 97.80%
平均絶対誤差 (MAE): 0.0218 ✅
R²スコア: 0.9551 ✅
```

#### Step 7: モデルを保存

- 自動的に `trained_fd_model.pkl` として保存されます
- 学習履歴は `training_history.json` に追記されます

---

## 推論モード

### 🎯 目標
低画質画像からフラクタル次元を予測する

### 🚀 ステップバイステップガイド

#### Step 1: 推論モードを選択
1. トップページで「🔮 推論モード」を選択
2. サブモードで「🔮 通常予測モード」を選択

#### Step 2: モデルを読み込み

**既に学習済みの場合**:
- 自動的に `trained_fd_model.pkl` が読み込まれます

**モデルファイルがない場合**:
- 先に学習モードでモデルを作成してください

#### Step 3: 画像をアップロード

1. 「画像をアップロード」エリアに低画質画像をドラッグ&ドロップ
2. または「Browse files」をクリックして選択
3. 複数画像の一括アップロード可能

#### Step 4: 予測を実行

1. **「🔮 フラクタル次元を予測」ボタンをクリック**
2. 結果が表示されます:
   - 予測されたFD値
   - 信頼度スコア
   - 予測区間
   - 画像のプレビュー

#### Step 5: 結果を保存

- 必要に応じてスクリーンショットを保存
- または後述のCSVエクスポート機能を使用

---

## 精度検証モード

### 🎯 目標
作成したモデルの精度を客観的に評価する

### 📋 準備するもの
- 高画質画像と低画質画像のペア: **10-20組以上推奨**
- 学習に使っていない画像（テストデータ）を使うのが理想

### 🚀 ステップバイステップガイド

#### Step 1: 精度検証モードを選択
1. トップページで「🔮 推論モード」を選択
2. サブモードで「🎯 精度検証モード (高画質ペアで検証)」を選択

#### Step 2: 画像ペアをアップロード

1. **高画質画像をアップロード**:
   - 例: `IMG_5023.jpg`, `IMG_5024.jpg`, `IMG_5025.jpg`...

2. **低画質画像をアップロード**:
   - 例: `IMG_5023_low1.jpg`, `IMG_5024_low1.jpg`, `IMG_5025_low1.jpg`...

**重要**: ファイル名から自動的にペアリングされます
- `IMG_5023.jpg` ⇔ `IMG_5023_low1.jpg`
- `IMG_XXXX.jpg` ⇔ `IMG_XXXX_low1.jpg`

#### Step 3: 検証を実行

1. **「🎯 精度検証を実行」ボタンをクリック**
2. 処理が開始されます:
   - 各画像ペアの実測FDと予測FDを計算
   - 統計分析を実行
   - グラフを生成

#### Step 4: 結果を確認

**表示される統計情報**:
- ✅ **相関係数**: 0.95以上が優秀
- ✅ **MAE** (平均絶対誤差): 0.03以下が目標
- ✅ **RMSE** (二乗平均平方根誤差)
- ✅ **R²スコア**: 0.90以上が良好

**グラフ**:
1. 散布図: 実測値 vs 予測値
2. 誤差分布: 誤差のヒストグラム
3. 絶対誤差分布

**詳細結果テーブル**:
| No. | ベース名 | 実測FD | 予測FD | 誤差 | 相対誤差% |
|-----|---------|--------|--------|------|-----------|
| 1 | IMG_5023 | 2.6801 | 2.8347 | +0.1546 | 5.77% |

#### Step 5: 結果を保存

1. **CSVダウンロード**:
   - 「📥 検証結果をCSVダウンロード」ボタンをクリック
   - ファイル名: `validation_results_YYYYMMDD_HHMMSS.csv`

2. **スクリーンショット**:
   - グラフや統計情報を画面キャプチャして保存

---

## ベストプラクティス

### 🌟 高精度モデルを作成するための推奨設定

#### 最高精度を目指す場合（相関係数97%以上）
```
✅ 品質レベル: low1
✅ データ拡張: 28種類すべて選択
✅ 画像ペア数: 30組以上
✅ 期待される結果:
   - 相関係数: 97.25%
   - MAE: 0.024
   - 相対誤差: 1-2%
```

#### バランス型（汎用性重視）
```
✅ 品質レベル: low4-7グループ
✅ データ拡張: 28種類すべて選択
✅ 画像ペア数: 30組以上
✅ 期待される結果:
   - 相関係数: 94.14%
   - MAE: 0.037
   - 様々な品質レベルに対応可能
```

### 📊 データ数の目安

| 元画像数 | データ拡張 | 品質レベル | 合計データ数 | 期待精度 |
|---------|-----------|-----------|-------------|----------|
| 30組 | 28種類 | low1 | 870組 | 97%+ |
| 30組 | 28種類 | low4-7 | 3,480組 | 94%+ |
| 100組 | 28種類 | low1 | 2,900組 | 97%+ |

### ⚠️ 避けるべき設定

❌ **全レベル (low1-10) での学習**
- 理由: 品質差が大きすぎてAIが混乱
- 結果: MAE悪化、信頼度70%以下

❌ **データ拡張5種類以下**
- 理由: データ数不足、過学習のリスク
- 結果: 汎用性低下

❌ **画像ペア10組以下**
- 理由: 学習データ不足
- 結果: 精度が大きく低下

### 🎯 精度検証のベストプラクティス

1. **テストデータの準備**:
   - 学習に使っていない画像を使用
   - 最低10組、推奨20組以上

2. **複数回検証**:
   - 異なる画像セットで複数回検証
   - 結果の再現性を確認

3. **結果の記録**:
   - CSVファイルをすべて保存
   - スクリーンショットで可視化結果を保存

---

## トラブルシューティング

### 🔴 よくある問題と解決方法

#### 問題1: アプリが起動しない

**症状**:
```
ModuleNotFoundError: No module named 'streamlit'
```

**解決方法**:
1. 仮想環境が有効化されているか確認
2. 依存パッケージを再インストール:
```bash
pip install -r requirements.txt
```

---

#### 問題2: 画像ペアが検出されない

**症状**:
```
✅ 0組の画像ペアを検出しました
```

**解決方法**:
1. ファイル名を確認:
   - 高画質: `IMG_5023.jpg`
   - 低画質: `IMG_5023_low1.jpg` ← `_low1`が必要

2. フォルダパスを確認:
   - Windowsの場合: `E:\画質別頬画像(元画像＋10段階)`
   - パスに日本語が含まれていてもOK

3. ファイル拡張子を確認:
   - `.jpg`, `.JPG`, `.jpeg`など統一されているか

---

#### 問題3: 精度が低い（相関係数85%以下）

**症状**:
```
💫 精度改善が必要です
相関係数: 0.85
```

**解決方法**:

**チェック1: データ数は十分か**
```
❌ 不足: 画像ペア10組、データ拡張5種類 → 合計60組
✅ 十分: 画像ペア30組、データ拡張28種類 → 合計870組
```

**チェック2: 品質レベルは適切か**
```
❌ 避ける: 全レベル(low1-10) → 品質差大きすぎ
✅ 推奨: low1 または low4-7グループ
```

**チェック3: データ拡張は十分か**
```
❌ 不足: 5種類以下
✅ 推奨: 15種類以上、理想は28種類すべて
```

**改善手順**:
1. 学習モードで再学習
2. 品質レベルをlow1に変更
3. データ拡張を28種類すべて選択
4. 学習を実行
5. 精度検証で確認

---

#### 問題4: 検証結果の誤差が大きい（30%以上）

**症状**:
```
相対誤差: 34-38%
実測FD: 2.04
予測FD: 2.83
```

**原因**:
- 学習時と検証時でFD計算方法が異なっていた（修正済み）

**解決方法**:
1. 最新版のコードを使用しているか確認
2. アプリを再起動
3. 精度検証を再実行

**期待される結果**:
```
相対誤差: 1-5%
実測FD: 2.68
予測FD: 2.83
```

---

#### 問題5: GPUエラーが出る

**症状**:
```
CUDA out of memory
```

**解決方法**:
1. コード内で`use_gpu=False`に変更
2. または小さいバッチサイズで処理

---

#### 問題6: メモリ不足エラー

**症状**:
```
MemoryError
```

**解決方法**:
1. データ拡張の種類を減らす（28種類 → 15種類）
2. 一度に処理する画像数を減らす
3. 他のアプリケーションを閉じる

---

### 📞 サポート

問題が解決しない場合:
1. GitHubのIssuesに報告
2. エラーメッセージ全文をコピー
3. 実行環境を記載（OS、Pythonバージョン等）

---

## 付録

### A. ファイル構成

```
Fractal-Analyzer-V2/
├── fractal_app.py              # メインアプリケーション
├── trained_fd_model.pkl         # 学習済みモデル
├── training_history.json        # 学習履歴
├── requirements.txt             # 依存パッケージ
├── README.md                    # プロジェクト概要
├── USER_GUIDE.md               # 本ガイド
├── 起動.bat                    # 起動用バッチファイル
└── .venv/                      # 仮想環境
```

### B. 用語集

- **FD (Fractal Dimension)**: フラクタル次元。画像の複雑さを表す指標
- **MAE (Mean Absolute Error)**: 平均絶対誤差。予測誤差の平均
- **RMSE**: 二乗平均平方根誤差
- **R²スコア**: 決定係数。モデルの説明力を表す（1.0が最高）
- **相関係数**: 実測値と予測値の相関の強さ（1.0が完全相関）
- **データ拡張**: 元画像に変換を加えてデータ数を増やす技術

---

## 更新履歴

- 2025-11-11: 初版作成
  - 基本的な使用方法を網羅
  - トラブルシューティング追加
  - ベストプラクティス追加

---

## ライセンス

このプロジェクトのライセンスについては、`LICENSE`ファイルを参照してください。
