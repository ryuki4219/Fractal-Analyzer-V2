# フラクタル画像解析アプリ - 新UI バージョン

## 🎨 新UIの特徴

### コンパクト3カラムレイアウト

提案1(コンパクト3カラム)を実装し、一覧性と操作性を大幅に向上させました。

```
┌────────────┬─────────────────────┬────────────┐
│   左列     │      中央列         │   右列     │
│  (入力)    │     (結果)          │  (詳細)    │
├────────────┼─────────────────────┼────────────┤
│ ・画像     │ ・メトリクス        │ ・品質判定 │
│   プレビュー│ ・折れ線グラフ      │ ・従来AI   │
│ ・設定     │ ・円グラフ          │ ・AI補正   │
│   (Popover)│                     │ ・画像統計 │
└────────────┴─────────────────────┴────────────┘
```

#### レイアウトの利点

1. **一覧性が高い** - 重要な情報が一画面に収まる
2. **情報の階層化** - 左(入力)→中央(結果)→右(詳細)の自然な視線の流れ
3. **拡張性** - AI補正や統計など追加機能を右側に自然に配置可能
4. **Streamlitの強み** - `st.columns()`で簡単に実装可能

### 省スペース手法の活用

- **`st.expander()`**: 詳細情報・エラー・学習データプレビューを折りたたみ表示
- **`st.popover()`**: 設定パネル(閾値、リサイズ上限)をポップアップ表示
- **`st.metric()`のdelta活用**: AI補正の差分を1つのメトリクスで表現

## 🌈 色覚バリアフリー配色

### 採用カラーパレット: Okabe-Ito/Wong palette

科学的に検証された色覚バリアフリー配色を採用しました。

#### 折れ線グラフの配色

| 要素 | カラーコード | 色名 | 用途 |
|------|--------------|------|------|
| 実測データ | `#0173B2` | 青 | Box-Counting法の実測値 |
| AI補正 | `#029E73` | 緑 | 解像度補正AIの推定値 |
| 従来AI | `#DE8F05` | オレンジ | 従来の機械学習予測 |

#### 円グラフの配色

| 要素 | カラーコード | 色名 | 用途 |
|------|--------------|------|------|
| 白ピクセル | `#56B4E9` | 水色 | 空間占有率(白) |
| 黒ピクセル | `#ECE133` | 黄色 | 空間占有率(黒) |

#### その他のUI要素

| 要素 | カラーコード | 色名 | 用途 |
|------|--------------|------|------|
| 警告 | `#CC78BC` | ピンク | 品質チェック警告 |
| エラー | `#D55E00` | 朱色 | エラー表示 |

### 色覚バリアフリーの検証

- **1型色覚(赤弱)**: ✅ 青・緑・オレンジの区別が可能
- **2型色覚(緑弱)**: ✅ 青・緑・オレンジの区別が可能
- **3型色覚(青弱)**: ✅ 青・緑・オレンジの区別が可能
- **全色盲**: ✅ 明度差により識別可能

参考文献: [Bang Wong (2011) "Points of view: Color blindness" Nature Methods 8, 441](https://www.nature.com/articles/nmeth.1618)

## 📊 UIコンポーネントの詳細

### 左カラム: 画像プレビュー & 設定

- **画像表示**: 元画像と二値化画像を縦並び表示
- **設定確認**: `st.popover()`で現在のパラメータを確認可能
  - 閾値
  - リサイズ上限
  - 画像サイズ
  - リサイズ率
  - 解像度補正AI有効/無効

### 中央カラム: 解析結果

#### メトリクス表示(3列)
1. **実測フラクタル次元**: Box-Counting法で計測
2. **AI補正フラクタル次元**: 解像度補正AIによる推定値(delta表示あり)
3. **空間占有率**: 白ピクセルの割合

#### グラフ表示
- **折れ線グラフ**: フラクタル次元の比較(実測/AI補正/従来AI)
- **円グラフ**: ピクセル分布(白/黒)

### 右カラム: 詳細診断 & AI比較

#### 品質判定
- **正常**: 緑色の成功メッセージ
- **要確認**: 赤色のエラーメッセージ + 異常検出の詳細(`st.expander()`)

#### 従来AI予測(`st.expander()`)
- 予測フラクタル次元
- 予測占有率
- 実測との差分(delta表示)

#### AI補正の詳細(`st.expander()`)
- 補正前/補正後の値
- 差分
- 変化率(%)

#### 画像統計(`st.expander()`)
- 平均輝度
- 標準偏差
- 元サイズ
- 白/黒ピクセル数

## 🚀 使い方

### 通常の解析

```bash
streamlit run fractal_app_新UI.py
```

ブラウザで `http://localhost:8501` にアクセス

### 解像度補正AIの使い方

1. **学習データ生成**:
   - サイドバー「学習データ生成モード」ON
   - 高解像度画像をアップロード
   - 20～100枚繰り返す

2. **モデル学習**:
   - 「解像度補正モデルを学習」ボタンをクリック

3. **補正の適用**:
   - 「解像度補正を有効化」ON
   - 低解像度画像をアップロード
   - AI補正結果を確認

## 📁 ファイル構成

- `fractal_app_新UI.py`: 新UIバージョン(このファイル)
- `fractal_app.py`: 旧バージョン(参考用)
- `model_joblib.pkl`: 学習済み回帰モデル
- `scaler_joblib.pkl`: 特徴量スケーラ
- `classifier_joblib.pkl`: 学習済み分類モデル
- `resolution_correction_model.pkl`: 解像度補正モデル
- `resolution_correction_scaler.pkl`: 解像度補正用スケーラ
- `train_data.csv`: 学習データ(従来AI)
- `resolution_training_data.csv`: 学習データ(解像度補正AI)
- `results.xlsx`: 解析結果(Excel)

## 🎯 今後の拡張案

### UI改善
- [ ] `st.dialog()`を使った一括処理結果のオーバーレイ表示(Streamlit 1.37+)
- [ ] ダークモード対応
- [ ] レスポンシブデザインの最適化

### 機能追加
- [ ] リアルタイムプレビュー
- [ ] カスタムカラーパレット選択
- [ ] PDF出力機能
- [ ] データベース連携

## 📝 変更履歴

### v2.0 (新UI) - 2025/10/05
- ✅ コンパクト3カラムレイアウト実装
- ✅ 色覚バリアフリー配色(Okabe-Ito/Wong palette)採用
- ✅ `st.popover()`による設定パネル実装
- ✅ `st.expander()`による詳細情報の階層化
- ✅ `st.metric()`のdelta表示によるAI補正差分の可視化
- ✅ グラフの視認性向上(線幅・マーカーサイズ・グリッド調整)

### v1.0 (旧UI)
- 2カラムレイアウト
- 基本的な色設定
- 解像度補正AI機能実装

## 📄 ライセンス

本プログラムはサンプル実装です。用途に応じて自由に改変してください。

## 🙏 謝辞

色覚バリアフリー配色は、Bang Wong氏の研究に基づいています。
