# 🎯 精度検証モード - 使い方ガイド

## 📌 概要

**精度検証モード**は、高画質・低画質のペア画像を使って、AIの予測精度を詳しく検証できる新機能です。

### ✨ できること

- ✅ **予測値 vs 実測値の比較**: AIの予測がどれだけ正確か確認
- ✅ **統計指標の自動計算**: 相関係数、MAE、RMSE、R²などの専門的指標
- ✅ **可視化**: 散布図、誤差分布のグラフ表示
- ✅ **画像ごとの詳細確認**: どの画像で誤差が大きいか特定
- ✅ **CSV エクスポート**: 結果をExcelで分析可能

---

## 🚀 使い方

### 1. モード選択

1. アプリを起動: `streamlit run fractal_app.py`
2. サイドバーで「🔮 推論モード」を選択
3. 「🎯 精度検証モード (高画質ペアで検証)」を選択

### 2. 画像の準備

#### ファイル名の規則

高画質と低画質の画像ペアは、**ファイル名で自動的にペアリング**されます。

**例:**
```
高画質: IMG_001.jpg
低画質: IMG_001_low4.jpg  ← ベース名が同じで _low4 がつく
```

#### サポートされるパターン

- `IMG_001.jpg` + `IMG_001_low1.jpg`
- `IMG_001.jpg` + `IMG_001_low4.jpg`
- `IMG_001.jpg` + `IMG_001_low8.jpg`
- `photo_123.jpg` + `photo_123_low5.jpg`

⚠️ **重要**: ベース名（拡張子と _low{数字} を除いた部分）が一致していれば自動ペアリングされます。

### 3. 画像アップロード

#### 高画質画像
- 「高画質画像」欄に、正解となる高画質の肌画像をアップロード
- 複数枚選択可能

#### 低画質画像
- 「低画質画像」欄に、AIで予測する低画質の肌画像をアップロード
- 複数枚選択可能

✅ アップロード後、自動的にペアリングされた組数が表示されます。

### 4. 検証実行

1. 「📋 検出されたペア一覧」を展開して、ペアが正しいか確認
2. 「🎯 精度検証を実行」ボタンをクリック
3. 処理中...（プログレスバー表示）
4. ✅ 検証完了！

---

## 📊 結果の見方

### 🎯 総合評価

アプリは4つの重要な指標を表示します：

#### 1. **相関係数 (Correlation)**
- **意味**: 予測値と実測値の関係の強さ
- **評価基準**:
  - 🌟 **S評価**: 0.95以上（優秀）
  - ⭐ **A評価**: 0.90～0.95（良好）
  - ✨ **B評価**: 0.85～0.90（許容）
  - 💫 **C評価**: 0.85未満（要改善）

#### 2. **MAE (平均絶対誤差)**
- **意味**: 予測と実測の平均的なズレ
- **評価基準**:
  - 🌟 **S評価**: 0.03以下（優秀）
  - ⭐ **A評価**: 0.03～0.05（良好）
  - ✨ **B評価**: 0.05～0.08（許容）
  - 💫 **C評価**: 0.08以上（要改善）
- **例**: MAE = 0.037 → 平均して±0.037のズレ

#### 3. **RMSE (二乗平均平方根誤差)**
- **意味**: 大きな誤差を重視した指標
- **理想**: 小さいほど良い（MAEより若干大きくなる）

#### 4. **R² (決定係数)**
- **意味**: モデルの説明力（0～1の範囲）
- **評価**:
  - 🌟 0.90以上: 優秀
  - ⭐ 0.80～0.90: 良好
  - ✨ 0.70～0.80: 許容
  - 💫 0.70未満: 要改善
- **例**: R² = 0.89 → モデルが89%の変動を説明できる

---

### 📈 詳細統計

#### 実測値の統計
- 高画質画像から計算された実際のフラクタル次元の分布

#### 予測値の統計
- AIが予測したフラクタル次元の分布

#### 誤差の統計
- **平均誤差 (Bias)**: 予測が実測より高いか低いか
  - 正の値: 予測が高めに出る傾向
  - 負の値: 予測が低めに出る傾向
  - ゼロ付近: バイアスなし（理想）
- **最大誤差**: 最も大きくズレた画像の誤差

---

### 📊 可視化グラフ

#### 1. 散布図（予測 vs 実測）
- **赤い破線**: 理想線（y=x）
- **点が線上に集まる**: 予測精度が高い
- **点が散らばる**: 予測精度が低い

#### 2. 誤差分布（ヒストグラム）
- **赤い破線**: 誤差ゼロ
- **緑の破線**: 平均誤差
- **左右対称**: バイアスなし
- **左右非対称**: 系統的な偏りあり

#### 3. 絶対誤差分布
- **赤い破線**: MAE（平均絶対誤差）
- **左に偏る**: 誤差が小さい（良い）
- **右に広がる**: 誤差が大きい（要改善）

---

### 📋 詳細結果テーブル

各画像ペアの結果が表形式で表示されます：

| 列名 | 意味 |
|------|------|
| **No.** | 画像番号 |
| **ベース名** | ファイル名（_low{数字}を除く） |
| **実測FD** | 高画質画像の実際のFD値 |
| **予測FD** | AIが予測したFD値 |
| **誤差** | 予測 - 実測（符号付き） |
| **絶対誤差** | |予測 - 実測|（大きさのみ） |
| **相対誤差%** | (絶対誤差 / 実測) × 100 |

**📥 CSV ダウンロード**: テーブルをCSV形式でダウンロード可能（Excelで分析できます）

---

### 🖼️ 画像ごとの詳細確認

「画像と誤差を表示」を展開すると、各画像ペアについて：

#### 表示内容
- **高画質画像**: 正解画像とそのFD値
- **低画質画像**: 予測に使った画像とAIの予測FD値
- **誤差評価**:
  - 🌟 **優秀**: 絶対誤差 ≤ 0.02
  - ⭐ **良好**: 絶対誤差 ≤ 0.05
  - ✨ **許容**: 絶対誤差 ≤ 0.08
  - 💫 **要改善**: 絶対誤差 > 0.08

#### 活用方法
- 誤差が大きい画像を特定
- なぜ誤差が大きいか分析（照明、角度、品質など）
- 学習データに似たような画像を追加するか検討

---

### 💬 評価コメント

総合評価に基づいて、アプリが自動的にコメントを表示：

#### 🌟 優秀な精度（相関0.95+、MAE≤0.03）
```
このモデルは実用レベルで使用できます
肌品質評価に十分な精度を持っています
```

#### ⭐ 良好な精度（相関0.90+、MAE≤0.05）
```
予測精度は実用的なレベルです
より多くのデータやデータ拡張で改善の余地があります
```

#### ✨ 許容範囲（相関0.85+、MAE≤0.08）
```
基本的な予測は可能ですが、改善の余地があります
データ数増加、データ拡張、品質レベルの見直しを検討してください
```

#### 💫 改善が必要（上記未満）
```
以下を確認してください:
1. 学習データ数は十分か (最低100組以上推奨)
2. データ拡張は適切か (15種類以上推奨)
3. 品質レベルの選択は適切か (low4-7推奨)
4. 画像の品質は適切か
```

---

## 💡 活用シーン

### 1. モデル性能の確認
**目的**: 学習したモデルがどれだけ正確か確認

**手順**:
1. 学習に使っていない画像ペアを用意（テストデータ）
2. 精度検証モードで検証
3. 相関係数とMAEを確認
4. 実用レベル（相関0.90+、MAE≤0.05）なら実用可能

### 2. 学習効果の比較
**目的**: データ拡張や品質レベル変更の効果を確認

**手順**:
1. 設定Aで学習 → 精度検証
2. 設定Bで学習 → 精度検証
3. 相関係数、MAEを比較
4. より良い設定を採用

### 3. 問題画像の特定
**目的**: どんな画像で予測が難しいか把握

**手順**:
1. 精度検証を実行
2. 「画像ごとの詳細確認」で誤差が大きい画像を確認
3. 共通点を分析（照明、角度、品質など）
4. 学習データにそのような画像を追加

### 4. 品質レベルの選定
**目的**: どの品質レベル（low1-10）が適切か判断

**手順**:
1. low4で学習 → 精度検証
2. low6で学習 → 精度検証
3. low8で学習 → 精度検証
4. 最も良い精度の品質レベルを選択

---

## 🔍 トラブルシューティング

### ⚠️ ペアが見つからない

**原因**: ファイル名のパターンが一致していない

**解決策**:
1. ファイル名を確認:
   - 高画質: `IMG_001.jpg`
   - 低画質: `IMG_001_low4.jpg`
2. ベース名が完全に一致しているか確認
3. アンダースコア (`_`) が正しく入っているか確認
4. 拡張子が同じか確認（.jpg、.png など）

### ⚠️ 精度が低い（相関<0.85、MAE>0.08）

**原因と対策**:

#### 1. データ数が不足
- **確認**: 学習データは100組以上か？
- **対策**: データ拡張で200組以上に増やす

#### 2. データ拡張が不足
- **確認**: 拡張種類は15種類以上か？
- **対策**: 水平反転、回転、明るさ、ガウシアンなど追加

#### 3. 品質レベルが不適切
- **確認**: low1-3 または low1-10 全レベルを使っていないか？
- **対策**: **low4-7**（中度劣化）を推奨

#### 4. 画像品質のばらつき
- **確認**: 照明、角度、ブレなどの条件が統一されているか？
- **対策**: 撮影条件を統一、または多様な条件の画像を学習データに追加

### ⚠️ バイアス（平均誤差）が大きい

**症状**: 平均誤差が +0.02 または -0.02 以上

**意味**:
- **正の値**: AIが常に高めに予測
- **負の値**: AIが常に低めに予測

**対策**:
1. 学習データのバランスを確認（FD値の分布が偏っていないか）
2. 異なる品質レベルのデータを追加
3. データ拡張の種類を見直し

---

## 📖 用語集

| 用語 | 意味 |
|------|------|
| **FD (フラクタル次元)** | 肌のきめ細かさを表す指標（2.0～3.0） |
| **相関係数** | 予測と実測の関係の強さ（-1～1、1に近いほど良い） |
| **MAE** | 平均絶対誤差（Mean Absolute Error）、誤差の平均 |
| **RMSE** | 二乗平均平方根誤差（大きな誤差を重視） |
| **R²** | 決定係数、モデルの説明力（0～1） |
| **バイアス** | 系統的な偏り（常に高めor低め） |
| **ペアリング** | 高画質と低画質の画像を対応付けること |

---

## 🎯 ベストプラクティス

### 推奨される検証データ数
- **最低**: 10組
- **推奨**: 20～30組
- **理想**: 50組以上

### 検証データの選び方
1. **学習に使っていない画像**を使用（テストデータ）
2. 様々なFD値の画像を含める（バランス良く）
3. 実際の使用シーンに近い画像を使う

### 目標とする精度
- **相関係数**: 0.90以上（S/A評価）
- **MAE**: 0.05以下（S/A評価）
- **バイアス**: ±0.01以内
- **R²**: 0.85以上

---

## 💪 次のステップ

### 精度が良好な場合（相関0.90+、MAE≤0.05）
✅ **実用可能！**
1. 通常予測モードで肌評価を開始
2. 定期的に検証データで精度をチェック
3. より多くの画像で検証して汎用性を確認

### 精度が低い場合（相関<0.85、MAE>0.08）
📚 **学習改善が必要**
1. 学習モードに戻る
2. データ拡張を15種類以上に増やす
3. 品質レベルをlow4-7に変更
4. 再学習後、再度検証

### さらに向上させたい場合
🚀 **上級テクニック**
1. 複数の品質レベルで学習（low4-7推奨）
2. データ拡張を20種類以上に
3. 元画像を100枚以上に増やす
4. 撮影条件を多様化

---

**あなたのモデルの精度を客観的に確認し、改善に活かしてください！** 🎯
